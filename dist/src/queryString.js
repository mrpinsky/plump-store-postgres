"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function selects(schema) {
    var selectArray = [];
    for (var attrName in schema.attributes) {
        selectArray.push("\"" + schema.storeData.sql.tableName + "\".\"" + attrName + "\"");
    }
    for (var relName in schema.relationships) {
        var rel = schema.relationships[relName].type;
        var otherName = rel.sides[relName].otherName;
        var otherFieldName = rel.storeData.sql.joinFields[otherName];
        var extraAgg = [];
        if (rel.extras) {
            for (var extra in rel.extras) {
                extraAgg.push("'" + extra + "'", "\"" + relName + "\".\"" + extra + "\"");
            }
        }
        var extraString = ", 'meta', jsonb_build_object(" + extraAgg.join(', ') + ")";
        selectArray.push("COALESCE(\n        array_agg(\n          distinct(\n            jsonb_build_object(\n              'id', \"" + relName + "\".\"" + otherFieldName + "\"\n              " + (extraAgg.length ? extraString : '') + "\n            )\n          )\n        )\n        FILTER (WHERE \"" + relName + "\".\"" + otherFieldName + "\" IS NOT NULL),\n        '{}')\n      as \"" + relName + "\"");
    }
    return "select " + selectArray.join(', ');
}
function joins(schema) {
    var joinStrings = [];
    for (var relName in schema.relationships) {
        var rel = schema.relationships[relName].type;
        var sqlBlock = rel.storeData.sql;
        if (sqlBlock.joinQuery) {
            joinStrings.push("left outer join " + rel.storeData.sql.tableName + " as \"" + relName + "\" " + sqlBlock.joinQuery[relName]);
        }
        else {
            joinStrings.push("left outer join " + rel.storeData.sql.tableName + " as \"" + relName + "\" "
                + ("on \"" + relName + "\"." + sqlBlock.joinFields[relName] + " = " + schema.storeData.sql.tableName + "." + schema.idAttribute));
        }
    }
    return joinStrings.join('\n');
}
function singleWhere(schema) {
    if (schema.storeData && schema.storeData.sql && schema.storeData.sql.singleQuery) {
        return schema.storeData.sql.singleQuery;
    }
    else {
        return "where " + schema.storeData.sql.tableName + "." + schema.idAttribute + " = ?";
    }
}
function bulkWhere(schema) {
    if (schema.storeData && schema.storeData.sql && schema.storeData.sql.bulkQuery) {
        return schema.storeData.sql.bulkQuery;
    }
    else if (schema.storeData && schema.storeData.sql && schema.storeData.sql.singleQuery) {
        return schema.storeData.sql.singleQuery;
    }
    else {
        return "where " + schema.storeData.sql.tableName + "." + schema.idAttribute + " = ?";
    }
}
function groupBy(schema) {
    return "group by " + Object.keys(schema.attributes).map(function (attrName) { return "\"" + attrName + "\""; }).join(', ');
}
function bulkQuery(schema) {
    return {
        queryString: selects(schema) + " \nfrom " + schema.storeData.sql.tableName + " \n" + joins(schema) + " \n" + bulkWhere(schema) + " \n" + groupBy(schema) + ";",
        fields: ['id']
    };
}
exports.bulkQuery = bulkQuery;
function readQuery(schema) {
    return {
        queryString: selects(schema) + " \nfrom " + schema.storeData.sql.tableName + " \n" + joins(schema) + " \n" + singleWhere(schema) + " \n" + groupBy(schema) + ";",
        fields: ['id'],
    };
}
exports.readQuery = readQuery;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QjtJQUNsQyxNQUFNLENBQUMsY0FBWSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQyxRQUFRLElBQUssT0FBQSxPQUFJLFFBQVEsT0FBRyxFQUFmLENBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUcsQ0FBQztBQUNwRyxDQUFDO0FBRUQsbUJBQTBCLE1BQW1CO0lBQzNDLE1BQU0sQ0FBQztRQUNMLFdBQVcsRUFBSyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFXLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsV0FBTSxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQU0sU0FBUyxDQUFDLE1BQU0sQ0FBQyxXQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBRztRQUMxSSxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUM7S0FDZixDQUFDO0FBQ0osQ0FBQztBQUxELDhCQUtDO0FBRUQsbUJBQTBCLE1BQW1CO0lBQzNDLE1BQU0sQ0FBQztRQUNMLFdBQVcsRUFBSyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFXLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsV0FBTSxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQU0sV0FBVyxDQUFDLE1BQU0sQ0FBQyxXQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBRztRQUM1SSxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUM7S0FDZixDQUFDO0FBQ0osQ0FBQztBQUxELDhCQUtDIiwiZmlsZSI6InNyYy9xdWVyeVN0cmluZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhcmFtZXRlcml6ZWRRdWVyeSB9IGZyb20gJy4vc2VtaVF1ZXJ5JztcbmltcG9ydCB7IE1vZGVsU2NoZW1hIH0gZnJvbSAncGx1bXAnO1xuXG5mdW5jdGlvbiBzZWxlY3RzKHNjaGVtYTogTW9kZWxTY2hlbWEpIHtcbiAgY29uc3Qgc2VsZWN0QXJyYXkgPSBbXTtcbiAgZm9yIChjb25zdCBhdHRyTmFtZSBpbiBzY2hlbWEuYXR0cmlidXRlcykge1xuICAgIHNlbGVjdEFycmF5LnB1c2goYFwiJHtzY2hlbWEuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9XCIuXCIke2F0dHJOYW1lfVwiYCk7XG4gIH1cbiAgZm9yIChjb25zdCByZWxOYW1lIGluIHNjaGVtYS5yZWxhdGlvbnNoaXBzKSB7XG4gICAgY29uc3QgcmVsID0gc2NoZW1hLnJlbGF0aW9uc2hpcHNbcmVsTmFtZV0udHlwZTtcbiAgICBjb25zdCBvdGhlck5hbWUgPSByZWwuc2lkZXNbcmVsTmFtZV0ub3RoZXJOYW1lO1xuICAgIGNvbnN0IG90aGVyRmllbGROYW1lID0gcmVsLnN0b3JlRGF0YS5zcWwuam9pbkZpZWxkc1tvdGhlck5hbWVdO1xuICAgIGNvbnN0IGV4dHJhQWdnID0gW107XG4gICAgaWYgKHJlbC5leHRyYXMpIHtcbiAgICAgIGZvciAoY29uc3QgZXh0cmEgaW4gcmVsLmV4dHJhcykge1xuICAgICAgICBleHRyYUFnZy5wdXNoKGAnJHtleHRyYX0nYCwgYFwiJHtyZWxOYW1lfVwiLlwiJHtleHRyYX1cImApO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBleHRyYVN0cmluZyA9IGAsICdtZXRhJywganNvbmJfYnVpbGRfb2JqZWN0KCR7ZXh0cmFBZ2cuam9pbignLCAnKX0pYDtcbiAgICBzZWxlY3RBcnJheS5wdXNoKFxuICAgICAgYENPQUxFU0NFKFxuICAgICAgICBhcnJheV9hZ2coXG4gICAgICAgICAgZGlzdGluY3QoXG4gICAgICAgICAgICBqc29uYl9idWlsZF9vYmplY3QoXG4gICAgICAgICAgICAgICdpZCcsIFwiJHtyZWxOYW1lfVwiLlwiJHtvdGhlckZpZWxkTmFtZX1cIlxuICAgICAgICAgICAgICAke2V4dHJhQWdnLmxlbmd0aCA/IGV4dHJhU3RyaW5nIDogJyd9XG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgIEZJTFRFUiAoV0hFUkUgXCIke3JlbE5hbWV9XCIuXCIke290aGVyRmllbGROYW1lfVwiIElTIE5PVCBOVUxMKSxcbiAgICAgICAgJ3t9JylcbiAgICAgIGFzIFwiJHtyZWxOYW1lfVwiYFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGBzZWxlY3QgJHtzZWxlY3RBcnJheS5qb2luKCcsICcpfWA7XG59XG5cbmZ1bmN0aW9uIGpvaW5zKHNjaGVtYTogTW9kZWxTY2hlbWEpIHtcbiAgY29uc3Qgam9pblN0cmluZ3MgPSBbXTtcbiAgZm9yIChjb25zdCByZWxOYW1lIGluIHNjaGVtYS5yZWxhdGlvbnNoaXBzKSB7XG4gICAgY29uc3QgcmVsID0gc2NoZW1hLnJlbGF0aW9uc2hpcHNbcmVsTmFtZV0udHlwZTtcbiAgICBjb25zdCBzcWxCbG9jayA9IHJlbC5zdG9yZURhdGEuc3FsO1xuICAgIGlmIChzcWxCbG9jay5qb2luUXVlcnkpIHtcbiAgICAgIGpvaW5TdHJpbmdzLnB1c2goXG4gICAgICAgIGBsZWZ0IG91dGVyIGpvaW4gJHtyZWwuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9IGFzIFwiJHtyZWxOYW1lfVwiICR7c3FsQmxvY2suam9pblF1ZXJ5W3JlbE5hbWVdfWBcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGpvaW5TdHJpbmdzLnB1c2goXG4gICAgICAgIGBsZWZ0IG91dGVyIGpvaW4gJHtyZWwuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9IGFzIFwiJHtyZWxOYW1lfVwiIGBcbiAgICAgICAgKyBgb24gXCIke3JlbE5hbWV9XCIuJHtzcWxCbG9jay5qb2luRmllbGRzW3JlbE5hbWVdfSA9ICR7c2NoZW1hLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfS4ke3NjaGVtYS5pZEF0dHJpYnV0ZX1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gam9pblN0cmluZ3Muam9pbignXFxuJyk7XG59XG5cbmZ1bmN0aW9uIHNpbmdsZVdoZXJlKHNjaGVtYTogTW9kZWxTY2hlbWEpIHtcbiAgaWYgKHNjaGVtYS5zdG9yZURhdGEgJiYgc2NoZW1hLnN0b3JlRGF0YS5zcWwgJiYgc2NoZW1hLnN0b3JlRGF0YS5zcWwuc2luZ2xlUXVlcnkpIHtcbiAgICByZXR1cm4gc2NoZW1hLnN0b3JlRGF0YS5zcWwuc2luZ2xlUXVlcnk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGB3aGVyZSAke3NjaGVtYS5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX0uJHtzY2hlbWEuaWRBdHRyaWJ1dGV9ID0gP2A7XG4gIH1cbn1cblxuZnVuY3Rpb24gYnVsa1doZXJlKHNjaGVtYTogTW9kZWxTY2hlbWEpIHtcbiAgaWYgKHNjaGVtYS5zdG9yZURhdGEgJiYgc2NoZW1hLnN0b3JlRGF0YS5zcWwgJiYgc2NoZW1hLnN0b3JlRGF0YS5zcWwuYnVsa1F1ZXJ5KSB7XG4gICAgcmV0dXJuIHNjaGVtYS5zdG9yZURhdGEuc3FsLmJ1bGtRdWVyeTtcbiAgfSBlbHNlIGlmIChzY2hlbWEuc3RvcmVEYXRhICYmIHNjaGVtYS5zdG9yZURhdGEuc3FsICYmIHNjaGVtYS5zdG9yZURhdGEuc3FsLnNpbmdsZVF1ZXJ5KSB7XG4gICAgcmV0dXJuIHNjaGVtYS5zdG9yZURhdGEuc3FsLnNpbmdsZVF1ZXJ5O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBgd2hlcmUgJHtzY2hlbWEuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9LiR7c2NoZW1hLmlkQXR0cmlidXRlfSA9ID9gO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdyb3VwQnkoc2NoZW1hOiBNb2RlbFNjaGVtYSkge1xuICByZXR1cm4gYGdyb3VwIGJ5ICR7T2JqZWN0LmtleXMoc2NoZW1hLmF0dHJpYnV0ZXMpLm1hcCgoYXR0ck5hbWUpID0+IGBcIiR7YXR0ck5hbWV9XCJgKS5qb2luKCcsICcpfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWxrUXVlcnkoc2NoZW1hOiBNb2RlbFNjaGVtYSk6IFBhcmFtZXRlcml6ZWRRdWVyeSB7XG4gIHJldHVybiB7XG4gICAgcXVlcnlTdHJpbmc6IGAke3NlbGVjdHMoc2NoZW1hKX0gXFxuZnJvbSAke3NjaGVtYS5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX0gXFxuJHtqb2lucyhzY2hlbWEpfSBcXG4ke2J1bGtXaGVyZShzY2hlbWEpfSBcXG4ke2dyb3VwQnkoc2NoZW1hKX07YCwgLy8gdHNsaW50OmRpc2FibGUtbGluZSBtYXgtbGluZS1sZW5ndGhcbiAgICBmaWVsZHM6IFsnaWQnXVxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVhZFF1ZXJ5KHNjaGVtYTogTW9kZWxTY2hlbWEpOiBQYXJhbWV0ZXJpemVkUXVlcnkge1xuICByZXR1cm4ge1xuICAgIHF1ZXJ5U3RyaW5nOiBgJHtzZWxlY3RzKHNjaGVtYSl9IFxcbmZyb20gJHtzY2hlbWEuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9IFxcbiR7am9pbnMoc2NoZW1hKX0gXFxuJHtzaW5nbGVXaGVyZShzY2hlbWEpfSBcXG4ke2dyb3VwQnkoc2NoZW1hKX07YCwgLy8gdHNsaW50OmRpc2FibGUtbGluZSBtYXgtbGluZS1sZW5ndGhcbiAgICBmaWVsZHM6IFsnaWQnXSxcbiAgfTtcbn1cbiJdfQ==
