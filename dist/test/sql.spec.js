"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var pg = require("pg");
var chai = require("chai");
var chaiAsPromised = require("chai-as-promised");
var mergeOptions = require("merge-options");
var index_1 = require("../src/index");
var testType_1 = require("./testType");
var storageTests_1 = require("./storageTests");
chai.use(chaiAsPromised);
var expect = chai.expect;
function runSQL(command, opts) {
    if (opts === void 0) { opts = {}; }
    var connOptions = Object.assign({}, {
        user: 'postgres',
        host: 'localhost',
        port: 5432,
        database: 'postgres',
        charset: 'utf8',
    }, opts);
    var client = new pg.Client(connOptions);
    return new Promise(function (resolve) {
        client.connect(function (err) {
            if (err) {
                throw err;
            }
            client.query(command, function (err) {
                if (err) {
                    throw err;
                }
                client.end(function (err) {
                    if (err) {
                        throw err;
                    }
                    resolve();
                });
            });
        });
    });
}
function createDatabase(name) {
    return runSQL("DROP DATABASE if exists " + name + ";")
        .then(function () { return runSQL("CREATE DATABASE " + name + ";"); })
        .then(function () {
        return runSQL("\n      CREATE SEQUENCE testid_seq\n        START WITH 1\n        INCREMENT BY 1\n        NO MINVALUE\n        MAXVALUE 2147483647\n        CACHE 1\n        CYCLE;\n      CREATE TABLE tests (\n        id integer not null primary key DEFAULT nextval('testid_seq'::regclass),\n        name text,\n        \"otherName\" text,\n        extended jsonb not null default '{}'::jsonb\n      );\n      CREATE TABLE parent_child_relationship (parent_id integer not null, child_id integer not null);\n      CREATE UNIQUE INDEX children_join on parent_child_relationship (parent_id, child_id);\n      CREATE TABLE valence_children (parent_id integer not null, child_id integer not null, perm integer not null);\n      CREATE UNIQUE INDEX valence_children_join on valence_children (parent_id, child_id);\n      CREATE TABLE query_children (parent_id integer not null, child_id integer not null, perm integer not null);\n      CREATE UNIQUE INDEX query_children_join on query_children (parent_id, child_id);\n    ", { database: name });
    });
}
storageTests_1.testSuite({
    describe: describe, it: it, before: before, after: after,
}, {
    ctor: index_1.PGStore,
    opts: {
        sql: {
            connection: {
                database: 'plump_test',
                user: 'postgres',
                host: 'localhost',
                port: 5432,
            },
        },
        terminal: true,
    },
    name: 'Plump Postgres Store',
    before: function () { return createDatabase('plump_test'); },
    after: function (driver) {
        return driver.teardown()
            .then(function () { return runSQL('DROP DATABASE plump_test;'); });
    },
});
var sampleObject = {
    typeName: 'tests',
    attributes: {
        name: 'potato',
        otherName: 'elephantine',
        extended: {
            actual: 'rutabaga',
            otherValue: 42,
        },
    },
};
describe('postgres-specific behaviors', function () {
    var store;
    before(function () {
        return createDatabase('secondary_plump_test')
            .then(function () {
            store = new index_1.PGStore({
                sql: {
                    connection: {
                        database: 'secondary_plump_test',
                        user: 'postgres',
                        host: 'localhost',
                        port: 5432,
                    },
                },
                terminal: true,
            });
            return store.addSchema(testType_1.TestType);
        });
    });
    it('Returns extra contents', function () {
        return store.writeAttributes(sampleObject)
            .then(function (createdObject) {
            return store.writeRelationshipItem(createdObject, 'valenceChildren', { id: 100, meta: { perm: 1 } })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 101, meta: { perm: 1 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 102, meta: { perm: 2 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 103, meta: { perm: 3 } }); })
                .then(function () {
                var resultObject = mergeOptions({}, createdObject, {
                    relationships: {
                        queryChildren: [
                            { id: 102, meta: { perm: 2 } },
                            { id: 103, meta: { perm: 3 } },
                        ],
                        queryParents: [],
                        valenceChildren: [
                            { id: 100, meta: { perm: 1 } },
                        ],
                        valenceParents: [],
                        children: [],
                        parents: [],
                    }
                });
                return store.read(createdObject)
                    .then(function (res) {
                    return expect(res).to.deep.equal(resultObject);
                });
            });
        });
    });
    it('supports all hasMany relationships', function () {
        return store.writeAttributes(sampleObject)
            .then(function (createdObject) {
            return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 101, meta: { perm: 1 } })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 102, meta: { perm: 2 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 103, meta: { perm: 3 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'children', { id: 102 }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'children', { id: 103 }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'valenceChildren', { id: 102, meta: { perm: 20 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'valenceChildren', { id: 103, meta: { perm: 30 } }); })
                .then(function () { return store.readRelationship(createdObject, 'relationships.queryChildren'); })
                .then(function (v) { return expect(v.relationships.queryChildren).to.deep.equal([{ id: 102, meta: { perm: 2 } }, { id: 103, meta: { perm: 3 } }]); })
                .then(function () { return store.readRelationship(createdObject, 'relationships.children'); })
                .then(function (v) { return expect(v.relationships.children).to.deep.equal([{ id: 102 }, { id: 103 }]); })
                .then(function () { return store.readRelationship(createdObject, 'relationships.valenceChildren'); })
                .then(function (v) { return expect(v.relationships.valenceChildren).to.deep.equal([{ id: 102, meta: { perm: 20 } }, { id: 103, meta: { perm: 30 } }]); });
        });
    });
    it('returns many objects in a bulk Query', function () {
        return Promise.all([
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
        ])
            .then(function (created) {
            var createdObject = created[0];
            return Promise.all(created.map(function (obj) {
                return Promise.all([
                    store.writeRelationshipItem(obj, 'children', { id: obj.id * 100 + 1 }),
                    store.writeRelationshipItem(obj, 'children', { id: obj.id * 100 + 2 }),
                    store.writeRelationshipItem(obj, 'children', { id: obj.id * 100 + 3 }),
                ]);
            }))
                .then(function () { return store.bulkRead(createdObject); })
                .then(function (res) {
                expect(res).to.have.property('included').with.length(4);
                res.included.forEach(function (i) {
                    expect(i.relationships.children).to.deep.equal([
                        { id: i.id * 100 + 1 },
                        { id: i.id * 100 + 2 },
                        { id: i.id * 100 + 3 },
                    ]);
                });
            });
        });
    });
    after(function () {
        return store.teardown()
            .then(function () { return runSQL('DROP DATABASE secondary_plump_test;'); });
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsQ0FBQyxFQUFFLEdBQUcsR0FBRyxHQUFHLENBQUMsRUFBRTtxQkFDdkIsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsS0FBSyxDQUFDO1FBQ0osTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7YUFDdEIsSUFBSSxDQUFDLGNBQU0sT0FBQSxNQUFNLENBQUMscUNBQXFDLENBQUMsRUFBN0MsQ0FBNkMsQ0FBQyxDQUFDO0lBQzdELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9zcWwuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1lbnYgbm9kZSwgbW9jaGEqL1xuLyogZXNsaW50IG5vLXNoYWRvdzogMCAqL1xuXG5pbXBvcnQgKiBhcyBwZyBmcm9tICdwZyc7XG5pbXBvcnQgKiBhcyBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0ICogYXMgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgKiBhcyBtZXJnZU9wdGlvbnMgZnJvbSAnbWVyZ2Utb3B0aW9ucyc7XG5cbmltcG9ydCB7IFBHU3RvcmUgfSBmcm9tICcuLi9zcmMvaW5kZXgnO1xuaW1wb3J0IHsgVGVzdFR5cGUgfSBmcm9tICcuL3Rlc3RUeXBlJztcbmltcG9ydCB7IHRlc3RTdWl0ZSB9IGZyb20gJy4vc3RvcmFnZVRlc3RzJztcblxuaW1wb3J0IHsgSW5kZWZpbml0ZU1vZGVsRGF0YSB9IGZyb20gJ3BsdW1wJztcblxuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuY29uc3QgZXhwZWN0ID0gY2hhaS5leHBlY3Q7XG5cbi8vIFRlc3RUeXBlLiRzY2hlbWEucXVlcnlDaGlsZHJlbi5yZWxhdGlvbnNoaXAuJHNpZGVzLnF1ZXJ5Q2hpbGRyZW4uc2VsZi5xdWVyeS5yYXdKb2luID1cbi8vICdsZWZ0IG91dGVyIGpvaW4gcXVlcnlfY2hpbGRyZW4gYXMgcXVlcnljaGlsZHJlbiBvbiBxdWVyeWNoaWxkcmVuLnBhcmVudF9pZCA9IHRlc3RzLmlkIGFuZCBxdWVyeWNoaWxkcmVuLnBlcm0gPj0gMic7XG4vLyBUZXN0VHlwZS4kc2NoZW1hLnF1ZXJ5UGFyZW50cy5yZWxhdGlvbnNoaXAuJHNpZGVzLnF1ZXJ5UGFyZW50cy5zZWxmLnF1ZXJ5LnJhd0pvaW4gPVxuLy8gJ2xlZnQgb3V0ZXIgam9pbiBxdWVyeV9jaGlsZHJlbiBhcyBxdWVyeXBhcmVudHMgb24gcXVlcnlwYXJlbnRzLmNoaWxkX2lkID0gdGVzdHMuaWQgYW5kIHF1ZXJ5cGFyZW50cy5wZXJtID49IDInO1xuLy9cblxuXG5mdW5jdGlvbiBydW5TUUwoY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IGNvbm5PcHRpb25zID0gT2JqZWN0LmFzc2lnbihcbiAgICB7fSxcbiAgICB7XG4gICAgICB1c2VyOiAncG9zdGdyZXMnLFxuICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICBwb3J0OiA1NDMyLFxuICAgICAgZGF0YWJhc2U6ICdwb3N0Z3JlcycsXG4gICAgICBjaGFyc2V0OiAndXRmOCcsXG4gICAgfSxcbiAgICBvcHRzXG4gICk7XG4gIGNvbnN0IGNsaWVudCA9IG5ldyBwZy5DbGllbnQoY29ubk9wdGlvbnMpO1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBjbGllbnQuY29ubmVjdCgoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICAgIGNsaWVudC5xdWVyeShjb21tYW5kLCAoZXJyKSA9PiB7IC8vIHRzbGludDpkaXNhYmxlLWxpbmUgbm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuICAgICAgICBjbGllbnQuZW5kKChlcnIpID0+IHsgLy8gdHNsaW50OmRpc2FibGUtbGluZSBuby1zaGFkb3dlZC12YXJpYWJsZVxuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlRGF0YWJhc2UobmFtZSkge1xuICByZXR1cm4gcnVuU1FMKGBEUk9QIERBVEFCQVNFIGlmIGV4aXN0cyAke25hbWV9O2ApXG4gIC50aGVuKCgpID0+IHJ1blNRTChgQ1JFQVRFIERBVEFCQVNFICR7bmFtZX07YCkpXG4gIC50aGVuKCgpID0+IHtcbiAgICByZXR1cm4gcnVuU1FMKGBcbiAgICAgIENSRUFURSBTRVFVRU5DRSB0ZXN0aWRfc2VxXG4gICAgICAgIFNUQVJUIFdJVEggMVxuICAgICAgICBJTkNSRU1FTlQgQlkgMVxuICAgICAgICBOTyBNSU5WQUxVRVxuICAgICAgICBNQVhWQUxVRSAyMTQ3NDgzNjQ3XG4gICAgICAgIENBQ0hFIDFcbiAgICAgICAgQ1lDTEU7XG4gICAgICBDUkVBVEUgVEFCTEUgdGVzdHMgKFxuICAgICAgICBpZCBpbnRlZ2VyIG5vdCBudWxsIHByaW1hcnkga2V5IERFRkFVTFQgbmV4dHZhbCgndGVzdGlkX3NlcSc6OnJlZ2NsYXNzKSxcbiAgICAgICAgbmFtZSB0ZXh0LFxuICAgICAgICBcIm90aGVyTmFtZVwiIHRleHQsXG4gICAgICAgIGV4dGVuZGVkIGpzb25iIG5vdCBudWxsIGRlZmF1bHQgJ3t9Jzo6anNvbmJcbiAgICAgICk7XG4gICAgICBDUkVBVEUgVEFCTEUgcGFyZW50X2NoaWxkX3JlbGF0aW9uc2hpcCAocGFyZW50X2lkIGludGVnZXIgbm90IG51bGwsIGNoaWxkX2lkIGludGVnZXIgbm90IG51bGwpO1xuICAgICAgQ1JFQVRFIFVOSVFVRSBJTkRFWCBjaGlsZHJlbl9qb2luIG9uIHBhcmVudF9jaGlsZF9yZWxhdGlvbnNoaXAgKHBhcmVudF9pZCwgY2hpbGRfaWQpO1xuICAgICAgQ1JFQVRFIFRBQkxFIHZhbGVuY2VfY2hpbGRyZW4gKHBhcmVudF9pZCBpbnRlZ2VyIG5vdCBudWxsLCBjaGlsZF9pZCBpbnRlZ2VyIG5vdCBudWxsLCBwZXJtIGludGVnZXIgbm90IG51bGwpO1xuICAgICAgQ1JFQVRFIFVOSVFVRSBJTkRFWCB2YWxlbmNlX2NoaWxkcmVuX2pvaW4gb24gdmFsZW5jZV9jaGlsZHJlbiAocGFyZW50X2lkLCBjaGlsZF9pZCk7XG4gICAgICBDUkVBVEUgVEFCTEUgcXVlcnlfY2hpbGRyZW4gKHBhcmVudF9pZCBpbnRlZ2VyIG5vdCBudWxsLCBjaGlsZF9pZCBpbnRlZ2VyIG5vdCBudWxsLCBwZXJtIGludGVnZXIgbm90IG51bGwpO1xuICAgICAgQ1JFQVRFIFVOSVFVRSBJTkRFWCBxdWVyeV9jaGlsZHJlbl9qb2luIG9uIHF1ZXJ5X2NoaWxkcmVuIChwYXJlbnRfaWQsIGNoaWxkX2lkKTtcbiAgICBgLCB7IGRhdGFiYXNlOiBuYW1lIH0pO1xuICB9KTtcbn1cblxuXG50ZXN0U3VpdGUoe1xuICBkZXNjcmliZSwgaXQsIGJlZm9yZSwgYWZ0ZXIsXG59LCB7XG4gIGN0b3I6IFBHU3RvcmUsXG4gIG9wdHM6IHtcbiAgICBzcWw6IHtcbiAgICAgIGNvbm5lY3Rpb246IHtcbiAgICAgICAgZGF0YWJhc2U6ICdwbHVtcF90ZXN0JyxcbiAgICAgICAgdXNlcjogJ3Bvc3RncmVzJyxcbiAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICB9LFxuICAgIH0sXG4gICAgdGVybWluYWw6IHRydWUsXG4gIH0sXG4gIG5hbWU6ICdQbHVtcCBQb3N0Z3JlcyBTdG9yZScsXG4gIGJlZm9yZTogKCkgPT4gY3JlYXRlRGF0YWJhc2UoJ3BsdW1wX3Rlc3QnKSxcbiAgYWZ0ZXI6IChkcml2ZXIpID0+IHtcbiAgICByZXR1cm4gZHJpdmVyLnRlYXJkb3duKClcbiAgICAudGhlbigoKSA9PiBydW5TUUwoJ0RST1AgREFUQUJBU0UgcGx1bXBfdGVzdDsnKSk7XG4gIH0sXG59KTtcblxuY29uc3Qgc2FtcGxlT2JqZWN0OiBJbmRlZmluaXRlTW9kZWxEYXRhID0ge1xuICB0eXBlTmFtZTogJ3Rlc3RzJyxcbiAgYXR0cmlidXRlczoge1xuICAgIG5hbWU6ICdwb3RhdG8nLFxuICAgIG90aGVyTmFtZTogJ2VsZXBoYW50aW5lJyxcbiAgICBleHRlbmRlZDoge1xuICAgICAgYWN0dWFsOiAncnV0YWJhZ2EnLFxuICAgICAgb3RoZXJWYWx1ZTogNDIsXG4gICAgfSxcbiAgfSxcbn07XG5cbmRlc2NyaWJlKCdwb3N0Z3Jlcy1zcGVjaWZpYyBiZWhhdmlvcnMnLCAoKSA9PiB7XG4gIGxldCBzdG9yZTogUEdTdG9yZTtcbiAgYmVmb3JlKCgpID0+IHtcbiAgICByZXR1cm4gY3JlYXRlRGF0YWJhc2UoJ3NlY29uZGFyeV9wbHVtcF90ZXN0JylcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICBzdG9yZSA9IG5ldyBQR1N0b3JlKHtcbiAgICAgICAgc3FsOiB7XG4gICAgICAgICAgY29ubmVjdGlvbjoge1xuICAgICAgICAgICAgZGF0YWJhc2U6ICdzZWNvbmRhcnlfcGx1bXBfdGVzdCcsXG4gICAgICAgICAgICB1c2VyOiAncG9zdGdyZXMnLFxuICAgICAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgICBwb3J0OiA1NDMyLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHRlcm1pbmFsOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gc3RvcmUuYWRkU2NoZW1hKFRlc3RUeXBlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ1JldHVybnMgZXh0cmEgY29udGVudHMnLCAoKSA9PiB7XG4gICAgcmV0dXJuIHN0b3JlLndyaXRlQXR0cmlidXRlcyhzYW1wbGVPYmplY3QpXG4gICAgLnRoZW4oKGNyZWF0ZWRPYmplY3QpID0+IHtcbiAgICAgIHJldHVybiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ3ZhbGVuY2VDaGlsZHJlbicsIHsgaWQ6IDEwMCwgbWV0YTogeyBwZXJtOiAxIH0gfSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShjcmVhdGVkT2JqZWN0LCAncXVlcnlDaGlsZHJlbicsIHsgaWQ6IDEwMSwgbWV0YTogeyBwZXJtOiAxIH0gfSkpXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ3F1ZXJ5Q2hpbGRyZW4nLCB7IGlkOiAxMDIsIG1ldGE6IHsgcGVybTogMiB9IH0pKVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICdxdWVyeUNoaWxkcmVuJywgeyBpZDogMTAzLCBtZXRhOiB7IHBlcm06IDMgfSB9KSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0T2JqZWN0OiBJbmRlZmluaXRlTW9kZWxEYXRhID0gbWVyZ2VPcHRpb25zKHt9LCBjcmVhdGVkT2JqZWN0LCB7XG4gICAgICAgICAgcmVsYXRpb25zaGlwczoge1xuICAgICAgICAgICAgcXVlcnlDaGlsZHJlbjogW1xuICAgICAgICAgICAgICB7IGlkOiAxMDIsIG1ldGE6IHsgcGVybTogMiB9IH0sXG4gICAgICAgICAgICAgIHsgaWQ6IDEwMywgbWV0YTogeyBwZXJtOiAzIH0gfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBxdWVyeVBhcmVudHM6IFtdLFxuICAgICAgICAgICAgdmFsZW5jZUNoaWxkcmVuOiBbXG4gICAgICAgICAgICAgIHsgaWQ6IDEwMCwgbWV0YTogeyBwZXJtOiAxIH0gfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB2YWxlbmNlUGFyZW50czogW10sXG4gICAgICAgICAgICBjaGlsZHJlbjogW10sXG4gICAgICAgICAgICBwYXJlbnRzOiBbXSxcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gc3RvcmUucmVhZChjcmVhdGVkT2JqZWN0KVxuICAgICAgICAudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGV4cGVjdChyZXMpLnRvLmRlZXAuZXF1YWwocmVzdWx0T2JqZWN0KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ3N1cHBvcnRzIGFsbCBoYXNNYW55IHJlbGF0aW9uc2hpcHMnLCAoKSA9PiB7XG4gICAgcmV0dXJuIHN0b3JlLndyaXRlQXR0cmlidXRlcyhzYW1wbGVPYmplY3QpXG4gICAgLnRoZW4oKGNyZWF0ZWRPYmplY3QpID0+IHtcbiAgICAgIHJldHVybiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ3F1ZXJ5Q2hpbGRyZW4nLCB7IGlkOiAxMDEsIG1ldGE6IHsgcGVybTogMSB9IH0pXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ3F1ZXJ5Q2hpbGRyZW4nLCB7IGlkOiAxMDIsIG1ldGE6IHsgcGVybTogMiB9IH0pKVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICdxdWVyeUNoaWxkcmVuJywgeyBpZDogMTAzLCBtZXRhOiB7IHBlcm06IDMgfSB9KSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShjcmVhdGVkT2JqZWN0LCAnY2hpbGRyZW4nLCB7IGlkOiAxMDIgfSkpXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ2NoaWxkcmVuJywgeyBpZDogMTAzIH0pKVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICd2YWxlbmNlQ2hpbGRyZW4nLCB7IGlkOiAxMDIsIG1ldGE6IHsgcGVybTogMjAgfSB9KSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShjcmVhdGVkT2JqZWN0LCAndmFsZW5jZUNoaWxkcmVuJywgeyBpZDogMTAzLCBtZXRhOiB7IHBlcm06IDMwIH0gfSkpXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS5yZWFkUmVsYXRpb25zaGlwKGNyZWF0ZWRPYmplY3QsICdyZWxhdGlvbnNoaXBzLnF1ZXJ5Q2hpbGRyZW4nKSlcbiAgICAgIC50aGVuKCh2KSA9PiBleHBlY3Qodi5yZWxhdGlvbnNoaXBzLnF1ZXJ5Q2hpbGRyZW4pLnRvLmRlZXAuZXF1YWwoXG4gICAgICAgIFsgeyBpZDogMTAyLCBtZXRhOiB7IHBlcm06IDIgfSB9LCB7IGlkOiAxMDMsIG1ldGE6IHsgcGVybTogMyB9IH0gXVxuICAgICAgKSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLnJlYWRSZWxhdGlvbnNoaXAoY3JlYXRlZE9iamVjdCwgJ3JlbGF0aW9uc2hpcHMuY2hpbGRyZW4nKSlcbiAgICAgIC50aGVuKCh2KSA9PiBleHBlY3Qodi5yZWxhdGlvbnNoaXBzLmNoaWxkcmVuKS50by5kZWVwLmVxdWFsKFxuICAgICAgICBbIHsgaWQ6IDEwMiB9LCB7IGlkOiAxMDMgfSBdXG4gICAgICApKVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUucmVhZFJlbGF0aW9uc2hpcChjcmVhdGVkT2JqZWN0LCAncmVsYXRpb25zaGlwcy52YWxlbmNlQ2hpbGRyZW4nKSlcbiAgICAgIC50aGVuKCh2KSA9PiBleHBlY3Qodi5yZWxhdGlvbnNoaXBzLnZhbGVuY2VDaGlsZHJlbikudG8uZGVlcC5lcXVhbChcbiAgICAgICAgWyB7IGlkOiAxMDIsIG1ldGE6IHsgcGVybTogMjAgfSB9LCB7IGlkOiAxMDMsIG1ldGE6IHsgcGVybTogMzAgfSB9IF1cbiAgICAgICkpO1xuICAgIH0pO1xuICB9KTtcblxuICBpdCgncmV0dXJucyBtYW55IG9iamVjdHMgaW4gYSBidWxrIFF1ZXJ5JywgKCkgPT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICBzdG9yZS53cml0ZUF0dHJpYnV0ZXMoc2FtcGxlT2JqZWN0KSxcbiAgICAgIHN0b3JlLndyaXRlQXR0cmlidXRlcyhzYW1wbGVPYmplY3QpLFxuICAgICAgc3RvcmUud3JpdGVBdHRyaWJ1dGVzKHNhbXBsZU9iamVjdCksXG4gICAgICBzdG9yZS53cml0ZUF0dHJpYnV0ZXMoc2FtcGxlT2JqZWN0KSxcbiAgICAgIHN0b3JlLndyaXRlQXR0cmlidXRlcyhzYW1wbGVPYmplY3QpLFxuICAgIF0pXG4gICAgLnRoZW4oKGNyZWF0ZWQpID0+IHtcbiAgICAgIGNvbnN0IGNyZWF0ZWRPYmplY3QgPSBjcmVhdGVkWzBdO1xuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGNyZWF0ZWQubWFwKChvYmopID0+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0ob2JqLCAnY2hpbGRyZW4nLCB7IGlkOiAob2JqLmlkIGFzIG51bWJlcikgKiAxMDAgKyAxIH0pLFxuICAgICAgICAgIHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShvYmosICdjaGlsZHJlbicsIHsgaWQ6IChvYmouaWQgYXMgbnVtYmVyKSAqIDEwMCArIDIgfSksXG4gICAgICAgICAgc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKG9iaiwgJ2NoaWxkcmVuJywgeyBpZDogKG9iai5pZCBhcyBudW1iZXIpICogMTAwICsgMyB9KSxcbiAgICAgICAgXSk7XG4gICAgICB9KSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLmJ1bGtSZWFkKGNyZWF0ZWRPYmplY3QpKVxuICAgICAgLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICBleHBlY3QocmVzKS50by5oYXZlLnByb3BlcnR5KCdpbmNsdWRlZCcpLndpdGgubGVuZ3RoKDQpO1xuICAgICAgICByZXMuaW5jbHVkZWQuZm9yRWFjaCgoaSkgPT4ge1xuICAgICAgICAgIGV4cGVjdChpLnJlbGF0aW9uc2hpcHMuY2hpbGRyZW4pLnRvLmRlZXAuZXF1YWwoW1xuICAgICAgICAgICAgeyBpZDogaS5pZCAqIDEwMCArIDEgfSxcbiAgICAgICAgICAgIHsgaWQ6IGkuaWQgKiAxMDAgKyAyIH0sXG4gICAgICAgICAgICB7IGlkOiBpLmlkICogMTAwICsgMyB9LFxuICAgICAgICAgIF0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBhZnRlcigoKSA9PiB7XG4gICAgcmV0dXJuIHN0b3JlLnRlYXJkb3duKClcbiAgICAudGhlbigoKSA9PiBydW5TUUwoJ0RST1AgREFUQUJBU0Ugc2Vjb25kYXJ5X3BsdW1wX3Rlc3Q7JykpO1xuICB9KTtcbn0pO1xuIl19
